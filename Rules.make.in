#
# Rules.make: common makefile rules for oasys
#

#
# Targets are "native" and "arm"
# 
TARGET = @TARGET@

#
# Common settings extracted from the configure script
#
SRCDIR		= @SRCDIR@
CC		= @CC@
CXX		= @CXX@
DEPFLAGS	= @DEPFLAGS@
DEBUG 		= @DEBUG@
OPTIMIZE	= @OPTIMIZE@
CPPFLAGS	= -I$(SRCDIR) @CPPFLAGS@
WARN		= -Wall -Werror @OPTIMIZE_WARN@
CFLAGS		= $(CPPFLAGS) $(DEBUG) $(OPTIMIZE) $(DEPFLAGS) $(WARN)
LIBS		= @LIBS@
LDFLAGS		= @LDFLAGS@

#
# Add a phony rule to make sure this isn't included before the default
#
.PHONY: catchdefault
catchdefault:
	@echo "Rules.make should be included after the default rule is set"
	@exit 1

#
# Rule for generating a .o file from the corresponding .cc file;
# automatically creates dependencies via the dependency flags.
#
%.o: %.cc
	@rm -f $@; mkdir -p $(@D)
	$(CXX) $(CFLAGS) -c $< -o $@

%.o: %.c
	@rm -f $@; mkdir -p $(@D)
	$(CC) $(CFLAGS) -c $< -o $@

#
# Generate cpp output in .E files.
#
%.E: %.cc
	@rm -f $@; mkdir -p $(@D)
	$(CXX) $(CFLAGS) -c $< -E -o $@

%.E: %.c
	@rm -f $@; mkdir -p $(@D)
	$(CXX) $(CFLAGS) -c $< -E -o $@

#
# Always include all the .d files that we can find, based on all the
# source files we can find (unless they're specified).
#
ifeq ($(ALLSRCS),)
ALLSRCS := $(shell find . -name \*.cc -o -name \*.c)
endif
DEPFILES := $(ALLSRCS:%.cc=%.d)
DEPFILES := $(DEPFILES:%.c=%.d)
ifneq ($(DEPFILES),)
-include $(DEPFILES)
endif

echodep:
	@echo "allsrcs: $(ALLSRCS)"
	@echo "depfiles: $(DEPFILES)"

#
# Some rules for cleaning object files
#
clean: objclean depclean genclean libclean binclean

.PHONY: objclean
objclean:
	@echo "removing object files..."
	find . \( -name '*.[Eo]' \) -print0 | xargs -0 rm -f

.PHONY: depclean
depclean:
	@echo "removing dependency files..."
	find . \( -name '*.d' \) -print0 | xargs -0 rm -f

.PHONY: genclean
genclean:
	@echo "removing generated files: $(GENFILES)..."
	@test -z "$(GENFILES)" || rm -f $(GENFILES)

.PHONY: binclean
binclean:
	@echo "removing binary files: $(BINFILES)..."
	@test -z "$(BINFILES)" || rm -f $(BINFILES)

.PHONY: libclean
libclean:
	@echo "removing library files: $(LIBFILES)..."
	@test -z "$(LIBFILES)" || rm -f $(LIBFILES)

.PHONY: distclean
CFGFILES := Rules.make config.h config.cache
distclean: clean
	@echo "removing configure generated files: $(CFGFILES)..."
	@test -z "$(CFGFILES)" || rm -f $(CFGFILES)
